<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å•†å“æ¤œç´¢</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://rawgit.com/andrastoth/webcodecamjs/master/js/qrcodelib.js"></script>
  <script src="https://rawgit.com/andrastoth/webcodecamjs/master/js/webcodecamjs.js"></script>
</head>
<body>
  <header><h1>å•†å“æ¤œç´¢</h1></header>
  <input type="text" id="barcodeInput" placeholder="å•†å“åã¾ãŸã¯ãƒãƒ¼ã‚³ãƒ¼ãƒ‰">
  <button id="scanBtn">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³</button>
  <canvas id="barcode-canvas" style="width:100%;max-width:400px;"></canvas>
  <div id="searchResults"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "..." };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const name = sessionStorage.getItem("responsibilityName");
    const role = sessionStorage.getItem("responsibilityRole");
    const number = sessionStorage.getItem("responsibilityNumber");

    if (!name || !role || !number) location.href = "index.html";

    function searchProducts(keyword) {
      const resultsDiv = document.getElementById("searchResults");
      resultsDiv.innerHTML = "æ¤œç´¢ä¸­...";

      addDoc(collection(db, "searchLogs"), {
        userId: number,
        userName: name,
        role: role,
        keyword: keyword,
        timestamp: serverTimestamp()
      });

      getDocs(collection(db, "products")).then(snap => {
        resultsDiv.innerHTML = "";
        let found = false;
        snap.forEach(doc => {
          const data = doc.data();
          if (data.name?.toLowerCase().includes(keyword.toLowerCase()) || data.barcode?.includes(keyword)) {
            found = true;
            const div = document.createElement("div");
            div.innerHTML = `
              <strong>${data.name}</strong><br>
              ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: ${data.barcode}<br>
              åœ¨åº«æ•°: ${data.stock}<br>
              <a href="stock-inout.html?barcode=${data.barcode}">ğŸ“¥ åœ¨åº«æ“ä½œ</a>
              ${role === "ç®¡ç†è€…" ? ` | <a href="register-product.html?edit=${data.barcode}">ğŸ“ ç·¨é›†</a>` : ""}
              | <a href="product-history.html?barcode=${data.barcode}">ğŸ“œ å±¥æ­´</a>
            `;
            resultsDiv.appendChild(div);
          }
        });
        if (!found) resultsDiv.innerHTML = "<p>ä¸€è‡´ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>";
      });
    }

    document.getElementById("barcodeInput").addEventListener("keydown", e => {
      if (e.key === "Enter") searchProducts(e.target.value.trim());
    });

    document.getElementById("scanBtn").onclick = () => {
      const args = {
        resultFunction: result => {
          document.getElementById("barcodeInput").value = result.code;
          searchProducts(result.code);
        }
      };
      new WebCodeCamJS("#barcode-canvas").init(args).play();
    };
  </script>
</body>
</html>