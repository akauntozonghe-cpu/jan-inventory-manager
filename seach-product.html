<input type="text" id="barcodeInput" placeholder="商品名またはバーコード">
<button id="scanBtn">📷 スキャン</button>
<canvas id="barcode-canvas" style="width:100%;max-width:400px;"></canvas>
<div id="searchResults"></div>

<script type="module">
  import { setupBarcodeInput } from "./barcode-handler.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = { /* Firebase設定 */ };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const name = sessionStorage.getItem("responsibilityName");
  const role = sessionStorage.getItem("responsibilityRole");
  const number = sessionStorage.getItem("responsibilityNumber");

  function searchProducts(keyword) {
    const resultsDiv = document.getElementById("searchResults");
    resultsDiv.innerHTML = "検索中...";

    addDoc(collection(db, "searchLogs"), {
      userId: number,
      userName: name,
      role: role,
      keyword: keyword,
      timestamp: serverTimestamp()
    });

    getDocs(collection(db, "products")).then(snap => {
      resultsDiv.innerHTML = "";
      let found = false;
      snap.forEach(doc => {
        const data = doc.data();
        if (data.name?.toLowerCase().includes(keyword) || data.barcode?.includes(keyword)) {
          found = true;
          const div = document.createElement("div");
          div.innerHTML = `
            <strong>${data.name}</strong><br>
            バーコード: ${data.barcode}<br>
            在庫数: ${data.stock}<br>
            <a href="stock-inout.html?barcode=${data.barcode}">📦 在庫操作</a>
            ${role === "管理者" ? ` | <a href="register-product.html?edit=${data.barcode}">✏️ 編集</a>` : ""}
            | <a href="product-history.html?barcode=${data.barcode}">📜 履歴を見る</a>
          `;
          resultsDiv.appendChild(div);
        }
      });
      if (!found) resultsDiv.innerHTML = "<p>一致する商品が見つかりません</p>";
    });
  }

  setupBarcodeInput(searchProducts);
</script>