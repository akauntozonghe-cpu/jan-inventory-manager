// register.js
import { db, auth } from "./firebase.js";
import {
  collection,
  addDoc,
  query,
  where,
  getDocs,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

// âœ… ç®¡ç†ç•ªå·ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
function generateAdminCode(jan, lot) {
  return `${jan}-${lot}`;
}
function generateControlId(adminCode, count) {
  return `${adminCode}-${count + 1}`;
}
async function getExistingCount(adminCode) {
  const q = query(collection(db, "items"), where("adminCode", "==", adminCode));
  const snapshot = await getDocs(q);
  return snapshot.size;
}
async function applyAutoGenerate() {
  const msgBox = document.getElementById("registerMessage");
  const jan = document.getElementById("janInput").value.trim();
  const lot = document.getElementById("lotInput").value.trim();

  if (!jan || !lot) {
    msgBox.textContent = "âš ï¸ JANã‚³ãƒ¼ãƒ‰ã¨Lotç•ªå·ã¯å¿…é ˆã§ã™ã€‚";
    msgBox.style.color = "red";
    return;
  }

  const adminCode = generateAdminCode(jan, lot);
  const count = await getExistingCount(adminCode);
  const controlId = generateControlId(adminCode, count);

  document.getElementById("controlId").value = controlId;
  const adminCodeInput = document.getElementById("adminCode");
  if (adminCodeInput) adminCodeInput.value = adminCode;

  msgBox.textContent = "âœ… ç®¡ç†ç•ªå·ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸ";
  msgBox.style.color = "green";
}

// âœ… DOMæ§‹ç¯‰å¾Œã®å‡¦ç†
document.addEventListener("DOMContentLoaded", () => {
  const msgBox = document.getElementById("registerMessage");

  // ç®¡ç†ç•ªå·è‡ªå‹•ç”Ÿæˆãƒœã‚¿ãƒ³
  const autoBtn = document.getElementById("autoGenerateBtn");
  if (autoBtn) autoBtn.addEventListener("click", applyAutoGenerate);

  // ç®¡ç†è€…å°‚ç”¨ï¼šé …ç›®è¿½åŠ UI
  const addFieldBtn = document.getElementById("addFieldBtn");
  const extraFields = document.getElementById("extraFields");
  if (addFieldBtn && extraFields) {
    addFieldBtn.addEventListener("click", () => {
      const wrapper = document.createElement("div");
      wrapper.className = "extraField";
      wrapper.innerHTML = `
        <input type="text" class="extraKey" placeholder="ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å" />
        <input type="text" class="extraValue" placeholder="å€¤" />
        <button type="button" class="delBtn">å‰Šé™¤</button>
      `;
      wrapper.querySelector(".delBtn").onclick = () => wrapper.remove();
      extraFields.appendChild(wrapper);
    });
  }

  // å•†å“ç™»éŒ²å‡¦ç†
  document.getElementById("registerForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const user = auth.currentUser;
    if (!user) {
      msgBox.textContent = "âš ï¸ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™";
      msgBox.style.color = "red";
      return;
    }

    const role = window.currentUserInfo?.role || "æœªè¨­å®š";
    const name = window.currentUserInfo?.name || "ä¸æ˜";
    const isAdmin = role === "ç®¡ç†è€…";

    let adminCode = form.adminCode ? form.adminCode.value.trim() : "";
    let controlId = form.controlId.value.trim();
    if (!adminCode || !controlId) {
      const jan = form.jan.value.trim();
      const lot = form.lot.value.trim();
      adminCode = generateAdminCode(jan, lot);
      const count = await getExistingCount(adminCode);
      controlId = generateControlId(adminCode, count);
    }

    const data = {
      jan: form.jan.value.trim(),
      lot: form.lot.value.trim(),
      adminCode,
      controlId,
      name: form.name.value.trim(),
      quantity: parseInt(form.quantity.value),
      unit: form.unit.value,
      expiry: form.expiry.value,
      maker: form.maker.value.trim(),
      location: form.location.value.trim(),
      categoryLarge: form.categoryLarge.value.trim(),
      categorySmall: form.categorySmall.value.trim(),
      photo: null,
      status: isAdmin ? "æ‰¿èªæ¸ˆ" : "ä¿ç•™",
      createdBy: user.uid,
      createdByName: name,
      updatedAt: serverTimestamp(),
      timestamp: serverTimestamp()
    };

    if (isAdmin && extraFields) {
      extraFields.querySelectorAll(".extraField").forEach(f => {
        const key = f.querySelector(".extraKey").value.trim();
        const val = f.querySelector(".extraValue").value.trim();
        if (key) data[key] = val;
      });
    }

    try {
      if (isAdmin) {
        await addDoc(collection(db, "items"), data);
        msgBox.textContent = "âœ… ç™»éŒ²å®Œäº†ï¼ˆå³ä¸€è¦§åæ˜ ï¼‰";
        msgBox.style.color = "green";
      } else {
        await addDoc(collection(db, "pendingItems"), data);
        msgBox.textContent = "âœ… ç™»éŒ²å®Œäº†ï¼ˆæ‰¿èªå¾…ã¡ãƒ»ç®¡ç†è€…ã«é€šçŸ¥ï¼‰";
        msgBox.style.color = "orange";
      }

      form.reset();
      if (form.adminCode) form.adminCode.value = "";
      form.controlId.value = "";
      document.getElementById("photoPreview").style.display = "none";
      if (extraFields) extraFields.innerHTML = "";
    } catch (error) {
      console.error("ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", error);
      msgBox.textContent = "âŒ ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
      msgBox.style.color = "red";
    }
  });

  // ç®¡ç†è€…è¡¨ç¤ºåˆ¶å¾¡
  const responsibleUser = document.getElementById("responsibleUser");
  const adminOnlyField = document.getElementById("adminOnlyField");

  onAuthStateChanged(auth, (user) => {
    if (user && adminOnlyField) {
      const role = window.currentUserInfo?.role || "æœªè¨­å®š";
      const name = window.currentUserInfo?.name || "ä¸æ˜";
      if (responsibleUser) {
        responsibleUser.textContent = `ğŸ‘‘ ${name}ï¼ˆ${role}ï¼‰`;
      }
      adminOnlyField.style.display = role === "ç®¡ç†è€…" ? "block" : "none";
    } else if (adminOnlyField) {
      adminOnlyField.style.display = "none";
    }
  });
});