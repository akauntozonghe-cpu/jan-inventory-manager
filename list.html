<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>商品一覧 - 在庫管理</title>

  <!-- 共通スタイル -->
  <link rel="stylesheet" href="header.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ヘッダー読み込み先 -->
  <div id="headerContainer"></div>

  <!-- ヘッダー読み込みとロジック統合 -->
  <script type="module">
    fetch("header.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("headerContainer").innerHTML = html;

        // ✅ ヘッダー挿入後にロジックを初期化
        import("./headerLogic.js").then(module => {
          if (module.initHeader) {
            module.initHeader();
          }
        });
      })
      .catch(err => {
        console.error("ヘッダー読み込み失敗:", err);
        document.getElementById("headerContainer").innerHTML =
          "<div style='color:red; padding:10px;'>ヘッダー読み込みに失敗しました</div>";
      });
  </script>

  <!-- 本体 -->
  <main class="dashboard" aria-label="商品一覧画面">
    <h1>商品一覧</h1>
    <div class="user-info" id="userInfo"></div>

    <input type="text" id="searchInput" placeholder="JANコードまたは商品名で検索" />
    <button id="searchBtn">検索</button>

    <div id="productList"></div>
    <p id="statusMsg"></p>
  </main>

  <!-- Firebase & 商品一覧ロジック -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      push,
      set
    } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCqPckkK9FkDkeVrYjoZQA1Y3HuOGuUGwI",
      authDomain: "inventory-app-312ca.firebaseapp.com",
      databaseURL: "https://inventory-app-312ca-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "inventory-app-312ca",
      storageBucket: "inventory-app-312ca.appspot.com",
      messagingSenderId: "245219344089",
      appId: "1:245219344089:web:e46105927c302e6a5788c8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const userName = sessionStorage.getItem("userName");
    const userRole = sessionStorage.getItem("userRole");
    document.getElementById("userInfo").textContent = `${userName}（${userRole}）として操作中`;

    let allProducts = [];

    function renderProducts(products) {
      const list = document.getElementById("productList");
      list.innerHTML = "";

      if (products.length === 0) {
        list.innerHTML = "<p>表示できる商品がありません。</p>";
        return;
      }

      products.forEach((item, index) => {
        const div = document.createElement("div");
        div.classList.add("product-card");

        div.innerHTML = `
          <strong>${item.商品名}</strong><br>
          JANコード：${item.JANコード}<br>
          数量：${item.数量} ${item.単位}<br>
          保管場所：${item.保管場所}<br>
          分類：${item.大分類} / ${item.小分類}<br>
          登録者：${item.登録者}（${item.権限}）<br>
          登録日時：${new Date(item.登録日時).toLocaleString("ja-JP")}
          <br><br>
          <label>数量変更：</label><input type="number" id="qty_${index}" value="${item.数量}" />
          <label>保管場所変更：</label><input type="text" id="loc_${index}" value="${item.保管場所}" />
          <button data-index="${index}" class="changeBtn">変更申請</button>
        `;

        list.appendChild(div);
      });

      // ボタンイベントをまとめて付与
      document.querySelectorAll(".changeBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const index = btn.dataset.index;
          submitChange(index);
        });
      });
    }

    function searchProducts() {
      const keyword = document.getElementById("searchInput").value.trim();
      const filtered = allProducts.filter(p =>
        p.JANコード.includes(keyword) || p.商品名.includes(keyword)
      );
      renderProducts(filtered);
    }

    document.getElementById("searchBtn").addEventListener("click", searchProducts);

    function submitChange(index) {
      const item = allProducts[index];
      const newQty = document.getElementById(`qty_${index}`).value;
      const newLoc = document.getElementById(`loc_${index}`).value;

      if (newQty == item.数量 && newLoc == item.保管場所) {
        document.getElementById("statusMsg").textContent = "変更がありません。";
        return;
      }

      const changeRef = push(ref(db, "changeRequests"));
      set(changeRef, {
        商品ID: item.JANコード,
        申請者: userName,
        権限: userRole,
        変更前: {
          数量: item.数量,
          保管場所: item.保管場所
        },
        変更後: {
          数量: newQty,
          保管場所: newLoc
        },
        申請日時: new Date().toISOString(),
        状態: "承認待ち"
      });

      document.getElementById("statusMsg").textContent = "変更申請を送信しました。";
    }

    // ✅ 初期読み込み（承認済み商品のみ表示）
    onValue(ref(db, "products"), (snapshot) => {
      const data = snapshot.val();
      const all = Object.values(data || {});
      allProducts = all.filter(p => p.状態 === "承認済");
      renderProducts(allProducts);
    });
  </script>
</body>
</html>