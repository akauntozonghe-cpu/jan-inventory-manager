<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ホーム - 在庫管理</title>
  <link rel="stylesheet" href="header.css" />
  <link rel="stylesheet" href="home.css" />

  <!-- Firebase SDK（互換モード） -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCqPckkK9FkDkeVrYjoZQA1Y3HuOGuUGwI",
      authDomain: "inventory-app-312ca.firebaseapp.com",
      projectId: "inventory-app-312ca",
      storageBucket: "inventory-app-312ca.appspot.com",
      messagingSenderId: "245219344089",
      appId: "1:245219344089:web:e46105927c302e6a5788c8"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>

  <!-- ヘッダーコンテナ -->
  <div id="headerContainer"></div>

  <!-- ヘッダー読み込みとロジック統合 -->
  <script>
    fetch("header.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("headerContainer").innerHTML = html;

        // ヘッダー制御ロジック
        const auth = firebase.auth();
        const db = firebase.firestore();

        const responsibleUser = document.getElementById("responsibleUser");
        const lastJudgment = document.getElementById("lastJudgment");
        const clock = document.getElementById("clock");
        const adminMenuItem = document.getElementById("adminMenuItem");

        function toggleMenu() {
          const menu = document.getElementById("headerMenu");
          if (menu) {
            menu.style.display = menu.style.display === "none" ? "block" : "none";
          }
        }

        function closeMenu(event) {
          if (event.target.tagName !== "A") {
            const menu = document.getElementById("headerMenu");
            if (menu) menu.style.display = "none";
          }
        }

        function goHome() {
          window.location.href = "home.html";
        }

        function logout() {
          auth.signOut().then(() => {
            alert("ログアウトしました");
            window.location.href = "index.html";
          }).catch((error) => {
            console.error("ログアウト失敗:", error);
            alert("ログアウトに失敗しました");
          });
        }

        function updateClock() {
          const now = new Date();
          const options = { month: "numeric", day: "numeric", weekday: "short", hour: "2-digit", minute: "2-digit", second: "2-digit" };
          const formatted = now.toLocaleString("ja-JP", options);
          if (clock) clock.textContent = `⏱ 現在：${formatted}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        auth.onAuthStateChanged(async (user) => {
          if (!user) {
            if (responsibleUser) responsibleUser.textContent = "👑 ログイン中：未取得";
            if (lastJudgment) lastJudgment.textContent = "🕒 最終ログイン：未取得";
            return;
          }

          const uid = localStorage.getItem("uid");
          if (!uid) return;

          try {
            const userDoc = await db.collection("users").doc(uid).get();
            const userData = userDoc.data();
            const name = userData?.name || "不明";
            const role = userData?.role || "未設定";

            if (responsibleUser) responsibleUser.textContent = `👑 ${name}（${role}）`;
            if (role === "管理者" && adminMenuItem) {
              adminMenuItem.style.display = "block";
            }

            const logs = await db.collection("loginLogs")
              .where("uid", "==", uid)
              .orderBy("timestamp", "desc")
              .limit(1)
              .get();

            if (!logs.empty) {
              const log = logs.docs[0].data();
              const ts = new Date(log.timestamp);
              const formatted = ts.toLocaleString("ja-JP", { month: "numeric", day: "numeric", weekday: "short", hour: "2-digit", minute: "2-digit" });
              if (lastJudgment) lastJudgment.textContent = `🕒 最終ログイン：${formatted}`;
            }
          } catch (err) {
            console.error("責任者情報取得失敗:", err);
          }
        });

        // グローバル登録
        window.toggleMenu = toggleMenu;
        window.closeMenu = closeMenu;
        window.goHome = goHome;
        window.logout = logout;
      });
  </script>

  <!-- ホーム本体 -->
  <main id="homeMain">
    <h2>🏠 ホーム</h2>

    <section>
      <h3>📊 状況サマリー</h3>
      <ul>
        <li>在庫あり：商品C</li>
        <li>不足：商品A</li>
        <li>廃棄予定：商品D</li>
      </ul>
    </section>

    <section>
      <h3>⏳ 期限の近いもの</h3>
      <ul>
        <li>商品B（本日）</li>
        <li>商品C（あと1日）</li>
        <li>商品F（あと1日）</li>
      </ul>
    </section>

    <section>
      <h3>📅 情報カレンダー</h3>
      <ul>
        <li>発注日：10/01</li>
        <li>商品E（16:00）</li>
        <li>商品F：期限更新（明日）</li>
        <li>フリマ更新（明日）</li>
      </ul>
    </section>

    <section>
      <h3>⚠️ 多機能AIの警告</h3>
      <ul>
        <li>商品C：「在庫が必要です」</li>
        <li>商品F：「期限が近いです」</li>
      </ul>
    </section>

    <section>
      <h3>🤖 AI在庫提案</h3>
      <table>
        <thead>
          <tr><th>商品</th><th>状況</th><th>提案</th></tr>
        </thead>
        <tbody>
          <tr><td>商品A</td><td>適期</td><td>出品または値下げ</td></tr>
          <tr><td>商品B</td><td>在庫少</td><td>出品または値下げ</td></tr>
          <tr><td>商品C</td><td>在庫なし</td><td>発注または提案</td></tr>
          <tr><td>商品D</td><td>不足</td><td>提案または発注</td></tr>
        </tbody>
      </table>
    </section>

    <section>
      <h3>🛍️ フリマ情報</h3>
      <ul>
        <li>商品B：価格改（¥1200）</li>
        <li>商品C：期限（9/13）</li>
        <li>商品F：期限（9/13）</li>
      </ul>
    </section>
  </main>

</body>
</html>