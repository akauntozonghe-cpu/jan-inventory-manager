<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>責任者ログイン</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .view { display: none; margin-top: 20px; }
    #logoutBtn { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>責任者番号でログイン</h2>
  <input type="text" id="responsibilityInput" placeholder="責任者番号を入力">
  <button onclick="handleLogin()">ログイン</button>

  <div id="adminView" class="view">
    <h3>🔧 管理者画面</h3>
    <p>在庫管理や責任者登録ができます。</p>
  </div>

  <div id="userView" class="view">
    <h3>📦 一般ユーザー画面</h3>
    <p>在庫の閲覧や登録ができます。</p>
  </div>

  <button id="logoutBtn" class="view" onclick="handleLogout()">ログアウト</button>

  <!-- ✅ Firebase CDN互換版 SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>

  <script>
    // ✅ Firebase設定（トさんのプロジェクト用）
    const firebaseConfig = {
      apiKey: "AIzaSyCqPckkK9FkDkeVrYjoZQA1Y3HuOGuUGwI",
      authDomain: "inventory-app-312ca.firebaseapp.com",
      databaseURL: "https://inventory-app-312ca-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "inventory-app-312ca",
      storageBucket: "inventory-app-312ca.firebasestorage.app",
      messagingSenderId: "245219344089",
      appId: "1:245219344089:web:e46105927c302e6a5788c8",
      measurementId: "G-TRH31MJCE3"
    };

    // ✅ 初期化
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ログイン処理
    async function handleLogin() {
      const input = document.getElementById("responsibilityInput").value.trim();
      if (!input) return alert("責任者番号を入力してください");

      try {
        const ref = db.collection("responsible-users").doc(input);
        const snap = await ref.get();

        if (!snap.exists) {
          alert("該当する責任者が見つかりません");
          return;
        }

        const data = snap.data();
        sessionStorage.setItem("responsibilityNumber", input);

        if (data.role === "admin") {
          showView("adminView");
        } else {
          showView("userView");
        }
      } catch (err) {
        console.error("ログイン失敗:", err);
        alert("Firestore接続に失敗しました。ネットワークまたは設定を確認してください。");
      }
    }

    // セッション復元
    window.addEventListener("DOMContentLoaded", async () => {
      const saved = sessionStorage.getItem("responsibilityNumber");
      if (!saved) return;

      try {
        const ref = db.collection("responsible-users").doc(saved);
        const snap = await ref.get();
        if (!snap.exists) return;

        const data = snap.data();
        if (data.role === "admin") {
          showView("adminView");
        } else {
          showView("userView");
        }
      } catch (err) {
        console.warn("セッション復元失敗:", err);
      }
    });

    // UI切り替え
    function showView(viewId) {
      document.getElementById("adminView").style.display = "none";
      document.getElementById("userView").style.display = "none";
      document.getElementById("logoutBtn").style.display = "block";
      document.getElementById(viewId).style.display = "block";
    }

    // ログアウト
    function handleLogout() {
      sessionStorage.clear();
      document.getElementById("adminView").style.display = "none";
      document.getElementById("userView").style.display = "none";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("responsibilityInput").value = "";
    }
  </script>
</body>
</html>